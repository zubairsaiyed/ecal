<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECAL Grid Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #ffffff;
            color: #000000;
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #ffffff;
            color: #000000;
            padding: 0;
            margin: 0;
            line-height: 1.4;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            max-height: 100vh;
        }

        .calendar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .weekdays-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #000000;
            border: none;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
            height: 60px;
            min-height: 60px;
            max-height: 60px;
        }

        .weekday {
            background: #f5f5f5;
            padding: 16px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(min-content, 1fr);
            gap: 1px;
            background: #000000;
            border: none;
            margin: 0;
            padding: 0;
            flex: 1 1 auto;
            min-height: 0;
            height: calc(100vh - 60px);
            overflow: hidden;
            align-content: start;
        }

        .day-cell {
            background: #ffffff;
            min-height: min-content;
            height: auto;
            padding: 12px;
            border: none;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .day-cell.other-month {
            background: #f9f9f9;
            color: #999999;
        }

        .day-cell.past {
            background: #f8f8f8;
        }

        .day-cell.past .day-number {
            color: #cccccc;
            font-weight: 400;
            border-bottom-color: #e8e8e8;
        }

        .day-cell.today {
            background: #f0f0f0;
            outline: 1px solid #000000;
            outline-offset: -1px;
        }

        .day-number {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e0e0e0;
        }

        .day-cell.today .day-number {
            border-bottom: 3px solid #000000;
        }

        .events-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 0 1 auto;
            min-height: 0;
            overflow-y: visible;
        }

        .event {
            padding: 6px 10px;
            margin: 0;
            font-size: 20px;
            border-left: 4px solid #000000;
            background: #ffffff;
            cursor: default;
            line-height: 1.4;
        }

        .event.past {
            background: #f8f8f8;
            border-left-color: #cccccc;
        }

        .event.past .event-time,
        .event.past .event-title {
            color: #aaaaaa;
            font-weight: 400;
        }

        .event-time {
            font-weight: 600;
            color: #000000;
            margin-right: 8px;
            font-size: 20px;
        }

        .event-title {
            color: #000000;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-size: 20px;
            word-wrap: break-word;
            word-break: break-word;
        }

        .event.all-day {
            border-left-color: #666666;
            background: #f5f5f5;
        }

        .event.all-day .event-time {
            color: #666666;
        }

        .more-events {
            font-size: 18px;
            color: #666666;
            padding: 4px 12px;
            font-style: italic;
        }

        /* Responsive adjustments for e-paper displays */
        /* Optimized for 13.3" 1200x1600 e-ink display */
        @media (max-width: 1200px) {
            .day-cell {
                min-height: 180px;
                padding: 10px;
            }
            .event {
                font-size: 18px;
                padding: 5px 8px;
            }
            .day-number {
                font-size: 24px;
            }
            .weekday {
                font-size: 22px;
            }
        }

        @media (max-width: 800px) {
            .day-cell {
                min-height: 140px;
                padding: 8px;
            }
            .event {
                font-size: 16px;
                padding: 4px 6px;
            }
            .day-number {
                font-size: 20px;
            }
            .weekday {
                font-size: 18px;
                padding: 12px 6px;
            }
        }

        /* Color e-ink optimized colors - matching spectra6 theme */
        .event-color-1 { border-left-color: #000000; } /* Black - vivid-black */
        .event-color-2 { border-left-color: #e60000; } /* Red - vivid-red */
        .event-color-3 { border-left-color: #ffd600; } /* Yellow - vivid-yellow */
        .event-color-4 { border-left-color: #0057e7; } /* Blue - vivid-blue */
        .event-color-5 { border-left-color: #000000; } /* Black fallback */
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="weekdays-header" id="weekdays-header"></div>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <script>
        const SETTINGS = {{ settings|tojson }};
        const FIRST_DAY = SETTINGS.first_day || 0; // 0 = Sunday, 1 = Monday
        const GRID_WEEKS = Math.max(1, Math.min(4, SETTINGS.grid_weeks || 2));
        const THEME = SETTINGS.theme || 'spectra6';
        const CALENDAR_COLORS = SETTINGS.calendar_colors || {};

        // Theme palettes
        const spectra_palette = {
            'vivid-red': '#e60000',
            'vivid-yellow': '#ffd600',
            'vivid-blue': '#0057e7',
            'vivid-black': '#000000'
        };
        const default_palette = [
            '#1E90FF', '#e60000', '#ffd600', '#28a745', '#6f42c1', '#000000'
        ];

        const WEEKDAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const WEEKDAY_NAMES_FULL = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        function getEventColor(event) {
            const calendarId = event.calendarId || '';
            let color = null;
            
            if (calendarId in CALENDAR_COLORS) {
                const colorKey = CALENDAR_COLORS[calendarId];
                if (THEME === 'spectra6' && colorKey in spectra_palette) {
                    color = spectra_palette[colorKey];
                } else if (THEME !== 'spectra6' && colorKey.startsWith('#') && (colorKey.length === 7 || colorKey.length === 4)) {
                    color = colorKey;
                }
            }
            
            // Fallback to palette
            if (!color) {
                if (THEME === 'spectra6') {
                    const vividKeys = Object.keys(spectra_palette);
                    const idx = Math.abs(hashCode(calendarId)) % vividKeys.length;
                    color = spectra_palette[vividKeys[idx]];
                } else {
                    const idx = Math.abs(hashCode(calendarId)) % default_palette.length;
                    color = default_palette[idx];
                }
            }
            
            // Map color to event-color class
            if (color === '#000000' || color === '#000') return 'event-color-1';
            if (color === '#e60000') return 'event-color-2';
            if (color === '#ffd600') return 'event-color-3';
            if (color === '#0057e7') return 'event-color-4';
            return 'event-color-1'; // Default to black
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash;
        }

        function formatTime(dateString, allDay) {
            if (allDay) return 'All Day';
            const date = new Date(dateString);
            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            const minutesStr = minutes.toString().padStart(2, '0');
            return `${hours}:${minutesStr} ${ampm}`;
        }

        function isAllDayEvent(event) {
            return event.start && !event.start.includes('T');
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function getWeekStart(date, firstDay) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = firstDay === 0 ? day : (day === 0 ? 6 : day - 1);
            d.setDate(d.getDate() - diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function renderWeekdays() {
            const header = document.getElementById('weekdays-header');
            header.innerHTML = '';
            
            const weekdays = FIRST_DAY === 0 
                ? WEEKDAY_NAMES 
                : [...WEEKDAY_NAMES.slice(1), WEEKDAY_NAMES[0]];
            
            weekdays.forEach(day => {
                const div = document.createElement('div');
                div.className = 'weekday';
                div.textContent = day;
                header.appendChild(div);
            });
        }

        function renderCalendar(events) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const weekStart = getWeekStart(today, FIRST_DAY);
            const startDate = new Date(weekStart);
            const endDate = new Date(weekStart);
            endDate.setDate(endDate.getDate() + (GRID_WEEKS * 7) - 1);
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Group events by date
            const eventsByDate = {};
            events.forEach(event => {
                const isAllDay = isAllDayEvent(event);
                const start = new Date(event.start);
                let end = new Date(event.end || event.start);
                
                // Handle multi-day events
                const currentDate = new Date(start);
                currentDate.setHours(0, 0, 0, 0);
                
                // For all-day events, end date is exclusive (day after event ends)
                // For timed events, end is the actual end time
                let endDateOnly = new Date(end);
                if (isAllDay) {
                    endDateOnly.setHours(0, 0, 0, 0);
                    endDateOnly.setDate(endDateOnly.getDate() - 1); // Make inclusive
                } else {
                    endDateOnly.setHours(0, 0, 0, 0);
                    // If end time is at midnight, it's the next day, so subtract 1
                    if (end.getHours() === 0 && end.getMinutes() === 0) {
                        endDateOnly.setDate(endDateOnly.getDate() - 1);
                    }
                }
                
                while (currentDate <= endDateOnly) {
                    const dateKey = getDateKey(currentDate);
                    if (!eventsByDate[dateKey]) {
                        eventsByDate[dateKey] = [];
                    }
                    // Create event copy for this day
                    const dayEvent = {
                        ...event,
                        displayDate: new Date(currentDate)
                    };
                    eventsByDate[dateKey].push(dayEvent);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
            
            // Sort events within each day
            Object.keys(eventsByDate).forEach(dateKey => {
                eventsByDate[dateKey].sort((a, b) => {
                    const aTime = isAllDayEvent(a) ? 0 : new Date(a.start).getTime();
                    const bTime = isAllDayEvent(b) ? 0 : new Date(b.start).getTime();
                    return aTime - bTime;
                });
            });
            
            // Render days
            const currentDate = new Date(startDate);
            const todayKey = getDateKey(today);
            const startMonth = startDate.getMonth();
            
            while (currentDate <= endDate) {
                const dateKey = getDateKey(currentDate);
                const isToday = dateKey === todayKey;
                const isPast = currentDate < today;
                const isOtherMonth = currentDate.getMonth() !== startMonth;
                
                const dayCell = document.createElement('div');
                let dayCellClass = 'day-cell';
                if (isOtherMonth) dayCellClass += ' other-month';
                if (isPast) dayCellClass += ' past';
                if (isToday) dayCellClass += ' today';
                dayCell.className = dayCellClass;
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = currentDate.getDate();
                dayCell.appendChild(dayNumber);
                
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'events-container';
                
                const dayEvents = eventsByDate[dateKey] || [];
                dayEvents.forEach(event => {
                    // Check if event is in the past
                    const eventStart = new Date(event.start);
                    const eventEnd = new Date(event.end || event.start);
                    const now = new Date();
                    const isEventPast = eventEnd < now;
                    
                    const eventDiv = document.createElement('div');
                    let eventClass = 'event ' + getEventColor(event);
                    if (isAllDayEvent(event)) eventClass += ' all-day';
                    if (isEventPast) eventClass += ' past';
                    eventDiv.className = eventClass;
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'event-time';
                    timeSpan.textContent = formatTime(event.start, isAllDayEvent(event));
                    
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'event-title';
                    titleSpan.textContent = event.title || 'No Title';
                    
                    eventDiv.appendChild(timeSpan);
                    eventDiv.appendChild(titleSpan);
                    eventsContainer.appendChild(eventDiv);
                });
                
                dayCell.appendChild(eventsContainer);
                grid.appendChild(dayCell);
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        // Set CSS variable for number of weeks to help with grid layout
        function setWeeksVariable() {
            document.documentElement.style.setProperty('--weeks-count', GRID_WEEKS);
        }

        // Adjust row heights based on content, prioritizing first rows
        function adjustRowHeights() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            
            const rows = [];
            const totalRows = GRID_WEEKS;
            
            // Group day cells by row (week)
            for (let i = 0; i < totalRows; i++) {
                const rowCells = [];
                for (let j = 0; j < 7; j++) {
                    const cellIndex = i * 7 + j;
                    const cell = grid.children[cellIndex];
                    if (cell) {
                        rowCells.push(cell);
                    }
                }
                if (rowCells.length > 0) {
                    rows.push(rowCells);
                }
            }
            
            // Calculate minimum height needed for each row based on content
            const rowMinHeights = rows.map(rowCells => {
                let maxHeight = 0;
                rowCells.forEach(cell => {
                    // Temporarily set height to auto to measure content
                    const originalHeight = cell.style.height;
                    cell.style.height = 'auto';
                    maxHeight = Math.max(maxHeight, cell.scrollHeight);
                    cell.style.height = originalHeight;
                });
                return maxHeight;
            });
            
            // Calculate total minimum height needed
            const totalMinHeight = rowMinHeights.reduce((sum, h) => sum + h, 0);
            const availableHeight = grid.offsetHeight;
            
            // If we have extra space, distribute it, but prioritize earlier rows
            if (availableHeight > totalMinHeight) {
                const extraSpace = availableHeight - totalMinHeight;
                // Give more space to earlier rows (exponential distribution)
                const rowHeights = rowMinHeights.map((minHeight, index) => {
                    // Earlier rows get more of the extra space
                    const priority = Math.pow(0.7, index); // 1.0, 0.7, 0.49, 0.34...
                    return minHeight + (extraSpace * priority / totalRows);
                });
                
                // Normalize to ensure total equals availableHeight
                const totalAllocated = rowHeights.reduce((sum, h) => sum + h, 0);
                const scaleFactor = availableHeight / totalAllocated;
                const finalHeights = rowHeights.map(h => h * scaleFactor);
                
                // Apply heights to rows
                rows.forEach((rowCells, rowIndex) => {
                    const rowHeight = finalHeights[rowIndex];
                    rowCells.forEach(cell => {
                        cell.style.height = `${rowHeight}px`;
                    });
                });
            } else {
                // Not enough space - use minimum heights
                rows.forEach((rowCells, rowIndex) => {
                    const rowHeight = rowMinHeights[rowIndex];
                    rowCells.forEach(cell => {
                        cell.style.height = `${rowHeight}px`;
                    });
                });
            }
        }

        // Fetch events and render
        fetch('/api/events')
            .then(response => response.json())
            .then(events => {
                setWeeksVariable();
                renderWeekdays();
                renderCalendar(events);
                // Adjust row heights after rendering
                setTimeout(adjustRowHeights, 100);
            })
            .catch(error => {
                console.error('Error fetching events:', error);
                setWeeksVariable();
                renderWeekdays();
                renderCalendar([]);
                setTimeout(adjustRowHeights, 100);
            });
    </script>
</body>
</html>

